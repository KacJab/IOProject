{% extends 'base.html' %}
{% block content %}
    <div class="container px-4 px-lg-5 d-flex h-100 align-items-center justify-content-center">
        <div class="d-flex justify-content-center">
            <div class="grid-container">
                <div class="col-6 grid-child">
                    <table class="table table-bordered table-dark" id="yourboard">
                    </table>
                </div>

                <div class=" col-6 grid-child">
                    <table class="table table-bordered table-dark" id="enemyboard">
                    </table>
                </div>
                <div class="col-6 grid-child">
                    <table class="table table-bordered table-dark" id="yourboard2">
                    </table>
                </div>

                <div class=" col-6 grid-child">
                    <table class="table table-bordered table-dark" id="enemyboard2">
                    </table>
                </div>
            </div>
        </div>
        <form id="resultform" method="POST">
            <input id="player1" type="text" name="player1">
            <input id="player2" type="text" name="player2">
            <input  type="submit" name="submit" value="submit">
        </form>
    </div>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

    <script>


        function randomly_locate_ships(boardToEdit, fleet) {
            let sum = 0;
            while (sum < 20) {
                sum = 0;

                for (let i = 0; i < fleet.length; i++) {
                    orient = Math.round(Math.random());
                    place_start = Math.floor(Math.random() * (10 - fleet[i]));
                    place_on_axis2 = Math.floor(Math.random() * 10);

                    for (let s = 1; s <= fleet[i]; s++) {
                        if (orient === 1) {
                            boardToEdit[place_start + s][place_on_axis2] = i + 1;
                        } else {
                            boardToEdit[place_on_axis2][place_start + s] = i + 1;
                        }
                    }
                }
                for (let i = 0; i < 10; i++) {
                    for (let j = 0; j < 10; j++) {
                        if (boardToEdit[i][j] !== 0) {
                            sum++;
                        }
                    }
                }
                sum = summingValuesIn2dArray(boardToEdit);
                if (sum < 20) {
                    for (let i = 0; i < 10; i++) {

                        for (let j = 0; j < 10; j++) {
                            boardToEdit[i][j] = 0;
                        }
                    }
                }
                console.log(sum);
            }
        }

        function summingValuesIn2dArray(array) {
            let sum = 0;
            for (let i = 0; i < array.length; i++) {
                for (let j = 0; j < array.length; j++) {
                    if (array[i][j] !== 0) {
                        sum++;
                    }
                }
            }
            return sum;
        }

        function createBoard(boardToDisplay, container1, container2) {


            let tbl = container1;
            let tbl2 = container2;

            let tblBody = document.createElement("tbody");
            let tblBody2 = document.createElement("tbody");

            for (let j = 0; j < 11; j++) {
                var row = document.createElement("tr");
                var row2 = document.createElement("tr");

                for (var i = 0; i < 11; i++) {

                    var cell = document.createElement("td");
                    var cell2 = document.createElement("td");

                    var cellText = document.createTextNode("0");
                    var cellText2 = document.createTextNode("0");


                    if (j === 0 && i !== 0) {
                        cellText = document.createTextNode(i);
                        cellText2 = document.createTextNode(i);
                    } else if (j === 0 && i === 0) {
                        cellText = document.createTextNode("X");
                        cellText2 = document.createTextNode("X");
                    } else if (i === 0) {
                        cellText = document.createTextNode(String.fromCharCode(64 + j));
                        cellText2 = document.createTextNode(String.fromCharCode(64 + j));
                    } else {
                        cellText = document.createTextNode(boardToDisplay[j - 1][i - 1]);
                        cellText.className = "your-field"
                        cell2.className = "enemys-field";
                        cell2.id = j + "," + i;
                    }

                    cell.appendChild(cellText);
                    cell2.appendChild(cellText2)
                    row.appendChild(cell);
                    row2.appendChild(cell2);
                }

                //row added to end of table body
                tblBody.appendChild(row);
                tblBody2.appendChild(row2);
            }

            // append the <tbody> inside the <table>
            tbl.appendChild(tblBody);
            tbl2.appendChild(tblBody2);

            tbl.setAttribute("border", "2");
            tbl2.setAttribute("border", "2");
        }

        function easy_mode(play, transcript, enemyboard) {
            while (play = 2) {
                let r = Math.floor(Math.random() * 10);
                let c = Math.floor(Math.random() * 10);
                while (document.getElementById(toString(x + 1) + "," + toString(y + 1)).className == "field checkedfield") {
                    r = Math.floor(Math.random() * 10);
                    c = Math.floor(Math.random() * 10);
                }

                if (enemyboard[r - 1][c - 1] == 0) {
                    transcript.push(String.fromCharCode(64 + r) + "," + c + "," + "o");

                    play = 2;
                    alert("pudło(" + String.fromCharCode(64 + r) + c.toString() + ") ruch 2. gracza");
                } else if (enemyboard[r - 1][c - 1] != 0) {
                    transcript.push(String.fromCharCode(64 + r) + "," + c + "," + "x");
                    console.log(enemyboard[r - 1][c - 1])

                    let control = 0;
                    for (let i = 0; i < 10; i++) {
                        for (let j = 0; j < 10; j++) {
                            if (enemyboard[i][j] == enemyboard[r - 1][c - 1]) {
                                control++;
                            }
                        }
                    }
                    enemyboard[r - 1][c - 1] = 0;
                    if (control == 1) {
                        alert("trafiony, zatopiony!" + parseInt(control));
                    } else {
                        alert("trafiony!" + parseInt(control));
                    }
                }

            }
        }

        $(document).ready(function () {

            let board = [];
            let board2 = [];
            let fleet = [];
            let player1_game_transcript = [];
            let player2_game_transcript = [];
            let difficulty_level = 0;

            let controlSum = 0;
            let controlSum2 = 0;


            let currentPlayer = 1;
            for (let i = 0; i < 10; i++) {
                board[i] = [];
                board2[i] = []
                for (let j = 0; j < 10; j++) {
                    board[i][j] = 0;
                    board2[i][j] = 0;
                }
            }

            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 4 - i; j++) {
                    fleet.push(i + 1)
                }
            }
            randomly_locate_ships(board, fleet);
            randomly_locate_ships(board2, fleet);

            console.log("board 1:");
            console.log(board);

            console.log("board 2:");
            console.log(board2);

            console.log(fleet);
            createBoard(board, document.getElementById("yourboard"), document.getElementById("enemyboard"));
            createBoard(board2, document.getElementById("yourboard2"), document.getElementById("enemyboard2"));

            $("#enemyboard2").hide();
            $("#yourboard2").hide();

            $(".enemys-field").click(function () {
                let rowcol = this.id.split(',');
                let r = parseInt(rowcol[0]);
                let c = parseInt(rowcol[1]);

                console.log(player1_game_transcript);
                console.log(player2_game_transcript);

                if (this.className === "enemys-field") {
                    this.className = "field checkedfield";
                    if (currentPlayer == 1) {

                        console.log(r + c);

                        if (board2[r - 1][c - 1] == 0) {
                            player1_game_transcript.push(String.fromCharCode(64 + r) + "," + c + "," + "o");

                            $("#enemyboard").hide();
                            $("#yourboard").hide();
                            $("#enemyboard2").show();
                            $("#yourboard2").show();
                            currentPlayer = 2;
                            alert("pudło(" + String.fromCharCode(64 + r) + c.toString() + ") ruch 2. gracza");
                        } else if (board2[r - 1][c - 1] != 0) {
                            controlSum++;
                            player1_game_transcript.push(String.fromCharCode(64 + r) + "," + c + "," + "x");
                            console.log(board2[r - 1][c - 1])

                            let control = 0;
                            for (let i = 0; i < 10; i++) {
                                for (let j = 0; j < 10; j++) {
                                    if (board2[i][j] == board2[r - 1][c - 1]) {
                                        control++;
                                    }
                                }
                            }
                            board2[r - 1][c - 1] = 0;
                            if (control == 1) {
                                alert("trafiony, zatopiony!" + parseInt(control));
                            } else {
                                alert("trafiony!" + parseInt(control));
                            }
                        }
                        if (controlSum == 20) {
                            alert("koniec gry wygrał gracz 1.");
                        }
                    } else if (currentPlayer == 2) {
                        if (difficulty_level == 0) {
                            if (board[r - 1][c - 1] === 0) {
                                player2_game_transcript.push(String.fromCharCode(64 + r) + "," + c.toString() + "," + "o");

                                $("#enemyboard2").hide();
                                $("#yourboard2").hide();
                                $("#enemyboard").show();
                                $("#yourboard").show();
                                currentPlayer = 1;
                                alert("pudło(" + String.fromCharCode(64 + r) + c.toString() + ") ruch 1. gracza");

                            } else if (board[r - 1][c - 1] != 0) {
                                controlSum2++;
                                player2_game_transcript.push(String.fromCharCode(64 + r) + "," + c.toString() + "," + "x");

                                console.log(board[r - 1][c - 1]);
                                let control = 0;
                                for (let i = 0; i < 10; i++) {
                                    for (let j = 0; j < 10; j++) {
                                        if (board[i][j] == board[r - 1][c - 1]) {
                                            control++;
                                        }
                                    }
                                }
                                board[r - 1][c - 1] = 0;
                                if (control == 1) {
                                    alert("trafiony, zatopiony!" + parseInt(control));
                                } else {
                                    alert("trafiony!" + parseInt(control));
                                }
                            }
                        } else if (difficulty_level == 1) {
                            easy_mode(currentPlayer, player2_game_transcript, board);
                        }
                        if (controlSum2 == 20) {
                            alert("koniec gry, wygrał gracz 2.");
                        }
                    }
                } else {
                    alert("już tam strzelałeś!")
                }
            });
        });
    </script>

    <script>
    $('#resultform').on('submit', function(e){
        e.preventDefault();
        $.ajax({
                type : "POST",
                url: "{% url 'saveresult' mode %}",
                data: {
                 player1 : $('#player1').val(),
                 player2 : $('#player2').val(),
                 csrfmiddlewaretoken: '{{ csrf_token }}',
                 dataType: "json",
                },

                success: function(data){
                    console.log(data)
                },

                failure: function() {

                }
            });
    });
    </script>
{% endblock content %}