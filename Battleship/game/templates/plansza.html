{% extends 'base.html' %}
{% block content %}
    <div class="container px-4 px-lg-5 d-flex h-100 align-items-center justify-content-center">
        <div class="d-flex justify-content-center">
            <h3>{{ user }} vs {{ player2_username }}</h3>
            <div class="grid-container">
                <div class="col-6 grid-child">
                    <table class="table table-bordered table-dark" id="player_1_own_board">
                    </table>
                </div>

                <div class=" col-6 grid-child">
                    <table class="table table-bordered table-dark" id="player_1_enemy_board">
                    </table>
                </div>
                <div class="col-6 grid-child">
                    <table class="table table-bordered table-dark" id="player_2_own_board">
                    </table>
                </div>

                <div class=" col-6 grid-child">
                    <table class="table table-bordered table-dark" id="player_2_enemy_board">
                    </table>
                </div>
            </div>
        </div>
        <form id="resultform" method="POST" action="{% url 'saveresult' mode %}">
            {% csrf_token %}
            <input id="mode" type="hidden" name="mode">
            <input id="player1" type="hidden" name="player1">
            <input id="player2" type="hidden" name="player2">
            <input id="result1" type="hidden" name="result1">
            <input id="result2" type="hidden" name="result2">
            <input id="transcript1" type="hidden" name="transcript1">
            <input id="transcript2" type="hidden" name="transcript2">
        </form>
    </div>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

    <script>


        function randomly_locate_ships(boardToEdit, fleet, board_to_control_neighborhood) {
            let orient, place_start, place_on_axis2;
            let all_clear = true;
            let not_complete = true;

            for (let i = 0; i < fleet.length; i++) {
                not_complete = true;
                while (not_complete) {
                    all_clear = true;
                    orient = Math.round(Math.random());
                    place_start = Math.floor(Math.random() * (10 - fleet[i]));
                    place_on_axis2 = Math.floor(Math.random() * 10);
                    for (let s = 1; s <= fleet[i]; s++) {
                        if (orient === 1) {
                            if (board_to_control_neighborhood[place_start + s][place_on_axis2] != 0) {
                                all_clear = false;
                                break;
                            }
                        } else {
                            if (board_to_control_neighborhood[place_on_axis2][place_start + s] != 0) {
                                all_clear = false;
                                break;
                            }
                        }
                    }
                    if (all_clear) {
                        for (let s = 1; s <= fleet[i]; s++) {
                            if (orient === 1) {
                                boardToEdit[place_start + s][place_on_axis2] = i + 1;
                                board_to_control_neighborhood[place_start + s][place_on_axis2] = 1;
                                if (place_on_axis2 > 0) {
                                    board_to_control_neighborhood[place_start + s][place_on_axis2 - 1] = 1;
                                    if (place_start + s > 0) {
                                        board_to_control_neighborhood[place_start + s - 1][place_on_axis2 - 1] = 1;
                                    }
                                }
                                if (place_on_axis2 < 9) {
                                    board_to_control_neighborhood[place_start + s][place_on_axis2 + 1] = 1;
                                    if (place_start + s > 0) {
                                        board_to_control_neighborhood[place_start + s - 1][place_on_axis2 + 1] = 1;
                                    }
                                }
                                if (place_start + s > 0) {
                                    board_to_control_neighborhood[place_start + s - 1][place_on_axis2] = 1;

                                }
                                if (place_start + s < 9) {
                                    board_to_control_neighborhood[place_start + s + 1][place_on_axis2] = 1;
                                    if (place_on_axis2 < 9) {
                                        board_to_control_neighborhood[place_start + s + 1][place_on_axis2 + 1] = 1;
                                    }
                                    if (place_on_axis2 > 0) {
                                        board_to_control_neighborhood[place_start + s + 1][place_on_axis2 - 1] = 1;

                                    }
                                }
                            } else {
                                boardToEdit[place_on_axis2][place_start + s] = i + 1;
                                board_to_control_neighborhood[place_on_axis2][place_start + s] = 1;
                                if (place_on_axis2 > 0) {
                                    board_to_control_neighborhood[place_on_axis2 - 1][place_start + s] = 1;
                                    if (place_start + s > 0) {
                                        board_to_control_neighborhood[place_on_axis2 - 1][place_start + s - 1] = 1;
                                    }
                                }
                                if (place_on_axis2 < 9) {
                                    board_to_control_neighborhood[place_on_axis2 + 1][place_start + s] = 1;
                                    if (place_start + s > 0) {
                                        board_to_control_neighborhood[place_on_axis2 + 1][place_start + s - 1] = 1;
                                    }
                                }
                                if (place_start + s > 0) {
                                    board_to_control_neighborhood[place_on_axis2][place_start + s - 1] = 1;
                                }
                                if (place_start + s < 9) {
                                    board_to_control_neighborhood[place_on_axis2][place_start + s + 1] = 1;
                                    if (place_on_axis2 < 9) {
                                        board_to_control_neighborhood[place_on_axis2 + 1][place_start + s + 1] = 1;
                                    }
                                    if (place_on_axis2 > 0) {
                                        board_to_control_neighborhood[place_on_axis2 - 1][place_start + s + 1] = 1;
                                    }
                                }
                            }
                        }
                        not_complete = false;
                    }
                }


            }
        }

        function summingValuesIn2dArray(array) {
            let sum = 0;
            for (let i = 0; i < array.length; i++) {
                for (let j = 0; j < array.length; j++) {
                    if (array[i][j] !== 0) {
                        sum++;
                    }
                }
            }
            return sum;
        }

        function createBoard(boardToDisplay, container1, container2) {

            let tbl = container1;
            let tbl2 = container2;

            let tblBody = document.createElement("tbody");
            let tblBody2 = document.createElement("tbody");

            for (let j = 0; j < 11; j++) {
                var row = document.createElement("tr");
                var row2 = document.createElement("tr");

                for (var i = 0; i < 11; i++) {

                    var cell = document.createElement("td");
                    var cell2 = document.createElement("td");

                    var cellText = document.createTextNode("O");
                    var cellText2 = document.createTextNode("O");


                    if (j === 0 && i !== 0) {
                        cellText = document.createTextNode(i);
                        cellText2 = document.createTextNode(i);
                    } else if (j === 0 && i === 0) {
                        cellText = document.createTextNode("X");
                        cellText2 = document.createTextNode("X");
                    } else if (i === 0) {
                        cellText = document.createTextNode(String.fromCharCode(64 + j));
                        cellText2 = document.createTextNode(String.fromCharCode(64 + j));
                    } else {
                        cellText = document.createTextNode(boardToDisplay[j - 1][i - 1]);
                        if (boardToDisplay[j - 1][i - 1] != 0) {
                            cellText = document.createTextNode("X");
                        }
                        cell.className = "your-field"
                        cell2.className = "enemys-field";
                        cell.id = j + "," + i;
                        cell2.id = j + "," + i;
                    }

                    cell.appendChild(cellText);
                    cell2.appendChild(cellText2)
                    row.appendChild(cell);
                    row2.appendChild(cell2);
                }

                //row added to end of table body
                tblBody.appendChild(row);
                tblBody2.appendChild(row2);
            }

            // append the <tbody> inside the <table>
            tbl.appendChild(tblBody);
            tbl2.appendChild(tblBody2);

            tbl.setAttribute("border", "2");
            tbl2.setAttribute("border", "2");
        }


        function easy_mode(transcript, enemy_board, controlSum2, playerNumber) {
            if (controlSum2 == 20) {
                return controlSum2;
            }
            let r = Math.floor(Math.random() * 10) + 1;
            let c = Math.floor(Math.random() * 10) + 1;
            let target_element = document.getElementById("player_1_own_board," + r + "," + c);
            console.log(target_element.id + " , " + target_element.className);

            while (target_element.className == "checkedfield") {
                r = Math.floor(Math.random() * 10) + 1;
                c = Math.floor(Math.random() * 10) + 1;
                target_element = document.getElementById("player_1_own_board," + r + "," + c);
                console.log(target_element.id + " , " + target_element.className);
            }

            if (enemy_board[r - 1][c - 1] == 0) {
                transcript.push(String.fromCharCode(64 + r) + "," + c + "," + "o");
                alert("pudło(" + String.fromCharCode(64 + r) + c.toString() + ") ruch 1. gracza");
                document.getElementById(target_element.id).style.backgroundColor = "blue";
                document.getElementById(target_element.id).className = "checkedfield";


            } else {
                transcript.push(String.fromCharCode(64 + r) + "," + c + "," + "x");
                document.getElementById(target_element.id).style.backgroundColor = "red";
                document.getElementById(target_element.id).className = "checkedfield";
                controlSum2++;
                let control = 0;
                for (let i = 0; i < 10; i++) {
                    for (let j = 0; j < 10; j++) {
                        if (enemy_board[i][j] == enemy_board[r - 1][c - 1]) {
                            control++;
                        }
                    }
                }
                enemy_board[r - 1][c - 1] = 0;
                if (control == 1) {
                    alert("Przeciwnik trafia, i zatapia twój okręt!!!!");

                } else {
                    alert("Przeciwnik trafia!");
                }


                controlSum2 = easy_mode(transcript, enemy_board, controlSum2);
            }
            return controlSum2;
        }

        function medium_mode(transcript, enemy_board, controlSum2) {
            if (controlSum2 == 20) {
                return controlSum2;
            }
            let last_shot_on_target = [];
            let r, c, target_element;
            {#transcript_reversed = transcript.reverse();#}
            for (const element of transcript) {
                transcript_split = element.split(',');
                if (transcript_split[2] == "x") {
                    last_shot_on_target = [transcript_split[0].charCodeAt(0) - 64, parseInt(transcript_split[1])];
                }
            }
            {#console.log(transcript_split[0].charCodeAt(0)+","+transcript_split[1]+","+transcript_split[2]);#}
            console.log(last_shot_on_target);

            if (last_shot_on_target.length == 0) {
                r = Math.floor(Math.random() * 10) + 1;
                c = Math.floor(Math.random() * 10) + 1;
                target_element = document.getElementById("player_1_own_board," + r + "," + c);
                console.log(target_element.id + " , " + target_element.className);

                while (target_element.className == "checkedfield") {
                    r = Math.floor(Math.random() * 10) + 1;
                    c = Math.floor(Math.random() * 10) + 1;
                    target_element = document.getElementById("player_1_own_board," + r + "," + c);
                    console.log(target_element.id + " , " + target_element.className);
                }
            } else {
                if (last_shot_on_target[0] > 1) {
                    r = last_shot_on_target[0] - 1;
                    c = last_shot_on_target[1];
                    target_element = document.getElementById("player_1_own_board," + r + "," + c);
                    console.log(target_element.id + " , " + target_element.className);
                }
                if (target_element.className == "checkedfield" || last_shot_on_target == 1) {
                    if (last_shot_on_target[1] < 10) {
                        r = last_shot_on_target[0];
                        c = last_shot_on_target[1] + 1;
                        target_element = document.getElementById("player_1_own_board," + r + "," + c);
                        console.log(target_element.id + " , " + target_element.className);
                    }
                    if (target_element.className == "checkedfield") {
                        if (last_shot_on_target[0] < 10) {
                            r = last_shot_on_target[0] + 1;
                            c = last_shot_on_target[1];
                            target_element = document.getElementById("player_1_own_board," + r + "," + c);
                            console.log(target_element.id + " , " + target_element.className);
                        }
                        if (target_element.className == "checkedfield") {
                            if (last_shot_on_target[1] > 1) {
                                r = last_shot_on_target[0];
                                c = last_shot_on_target[1] - 1;
                                target_element = document.getElementById("player_1_own_board," + r + "," + c);
                                console.log(target_element.id + " , " + target_element.className);
                                last_shot_on_target = [];
                            }
                            if (target_element.className == "checkedfield") {
                                r = Math.floor(Math.random() * 10) + 1;
                                c = Math.floor(Math.random() * 10) + 1;
                                target_element = document.getElementById("player_1_own_board," + r + "," + c);
                                console.log(target_element.id + " , " + target_element.className);

                                while (target_element.className == "checkedfield") {
                                    r = Math.floor(Math.random() * 10) + 1;
                                    c = Math.floor(Math.random() * 10) + 1;
                                    target_element = document.getElementById("player_1_own_board," + r + "," + c);
                                    console.log(target_element.id + " , " + target_element.className);
                                }
                            }
                        }
                    }
                }
            }
            if (enemy_board[r - 1][c - 1] == 0) {
                transcript.push(String.fromCharCode(64 + r) + "," + c + "," + "o");
                alert("pudło(" + String.fromCharCode(64 + r) + c.toString() + ") ruch 1. gracza");
                document.getElementById(target_element.id).style.backgroundColor = "blue";
                document.getElementById(target_element.id).className = "checkedfield";


            } else {
                transcript.push(String.fromCharCode(64 + r) + "," + c + "," + "x");
                document.getElementById(target_element.id).style.backgroundColor = "red";
                document.getElementById(target_element.id).className = "checkedfield";
                controlSum2++;
                let control = 0;
                for (let i = 0; i < 10; i++) {
                    for (let j = 0; j < 10; j++) {
                        if (enemy_board[i][j] == enemy_board[r - 1][c - 1]) {
                            control++;
                        }
                    }
                }
                enemy_board[r - 1][c - 1] = 0;
                if (control == 1) {
                    alert("Przeciwnik trafia, i zatapia twój okręt!!!!");
                } else {
                    alert("Przeciwnik trafia!");
                }


                controlSum2 = medium_mode(transcript, enemy_board, controlSum2);
            }
            return controlSum2;

        }


        function hard_mode(transcript, enemy_board, controlSum2, sunken_ships_locations, enemy_starting_board, potential_targets, line_of_shooting) {

            if (controlSum2 == 20) {
                return controlSum2;
            }
            let last_shot_on_target = [];
            let r, c, target_element, rand, transcript_split;
            console.log("zatopione statki:");
            console.log(sunken_ships_locations);
            for (const element of transcript) {
                transcript_split = element.split(',');
                if (transcript_split[2] == "x" && sunken_ships_locations.includes(last_shot_on_target) == false) {
                    last_shot_on_target = [transcript_split[0].charCodeAt(0) - 64, parseInt(transcript_split[1])];
                }

            }
            for (const ship of sunken_ships_locations) {
                if (ship[0] == last_shot_on_target[0] && ship[1] == last_shot_on_target[1]) {
                    last_shot_on_target = [];
                }
            }
            console.log("ostatni strzał:")
            console.log(last_shot_on_target);
            if (line_of_shooting.length != 0 && potential_targets.length == 0) {
                console.log("szukany błąd");
                if (line_of_shooting[0] = 1) {

                    console.log([last_shot_on_target[0] + 2, last_shot_on_target[1]]);
                    console.log([last_shot_on_target[0] - 2, last_shot_on_target[1]]);
                    potential_targets.push([last_shot_on_target[0] + 2, last_shot_on_target[1]]);
                    potential_targets.push([last_shot_on_target[0] - 2, last_shot_on_target[1]]);
                } else {
                    console.log([last_shot_on_target[0], last_shot_on_target[1] + 2]);
                    console.log([last_shot_on_target[0], last_shot_on_target[1] - 2]);
                    potential_targets.push([last_shot_on_target[0], last_shot_on_target[1] + 2]);
                    potential_targets.push([last_shot_on_target[0], last_shot_on_target[1] - 2]);
                }
                console.log("potencjalne strzały");
            }
            if (last_shot_on_target.length == 0) {

                r = Math.floor(Math.random() * 10) + 1;
                c = Math.floor(Math.random() * 10) + 1;
                target_element = document.getElementById("player_1_own_board," + r + "," + c);
                console.log(target_element.id + " , " + target_element.className);

                while (target_element.className == "checkedfield") {
                    r = Math.floor(Math.random() * 10) + 1;
                    c = Math.floor(Math.random() * 10) + 1;
                    target_element = document.getElementById("player_1_own_board," + r + "," + c);
                    console.log(target_element.id + " , " + target_element.className);

                }
            } else {
                if (last_shot_on_target[0] < 10 && potential_targets.includes([last_shot_on_target[0] + 1, last_shot_on_target[1]]) == false) {
                    if (document.getElementById("player_1_own_board," + (last_shot_on_target[0] + 1) + "," + last_shot_on_target[1]).className != "checkedfield") {
                        potential_targets.push([last_shot_on_target[0] + 1, last_shot_on_target[1]]);
                    }
                }
                if (last_shot_on_target[0] > 1 && potential_targets.includes([last_shot_on_target[0] - 1, last_shot_on_target[1]]) == false) {
                    if (document.getElementById("player_1_own_board," + (last_shot_on_target[0] - 1) + "," + last_shot_on_target[1]).className != "checkedfield") {
                        potential_targets.push([last_shot_on_target[0] - 1, last_shot_on_target[1]]);
                    }
                }
                if (last_shot_on_target[1] < 10 && potential_targets.includes([last_shot_on_target[0], last_shot_on_target[1] + 1]) == false) {
                    if (document.getElementById("player_1_own_board," + last_shot_on_target[0] + "," + (last_shot_on_target[1] + 1)).className != "checkedfield") {
                        potential_targets.push([last_shot_on_target[0], last_shot_on_target[1] + 1]);
                    }
                }
                if (last_shot_on_target[1] > 1 && potential_targets.includes([last_shot_on_target[0], last_shot_on_target[1] - 1]) == false) {
                    if (document.getElementById("player_1_own_board," + last_shot_on_target[0] + "," + (last_shot_on_target[1] - 1)).className != "checkedfield") {
                        potential_targets.push([last_shot_on_target[0], last_shot_on_target[1] - 1]);
                    }
                }

                for (let i = 0; i < potential_targets.length; i++) {
                    if (document.getElementById("player_1_own_board," + potential_targets[i][0] + "," + potential_targets[i][1]).className == "checkedfield") {
                        potential_targets.splice(i, 1);
                        i--;
                    }
                }
                for (let i = 0; i < potential_targets.length; i++) {
                    if (potential_targets[i][line_of_shooting[0]] != line_of_shooting[1]) {
                        potential_targets.splice(i, 1);
                        i--;
                    }
                }

                rand = Math.floor(Math.random() * potential_targets.length);
                r = potential_targets[rand][0];
                c = potential_targets[rand][1];
                target_element = document.getElementById("player_1_own_board," + r + "," + c);

                for (let i = 0; i < potential_targets.length; i++) {
                    if (potential_targets[i] == [r, c]) {
                        potential_targets.splice(i, 1);
                        i--;
                    }
                }
            }


            if (enemy_board[r - 1][c - 1] == 0) {
                transcript.push(String.fromCharCode(64 + r) + "," + c + "," + "o");
                alert("pudło(" + String.fromCharCode(64 + r) + c.toString() + ") ruch 1. gracza");
                document.getElementById(target_element.id).style.backgroundColor = "blue";
                document.getElementById(target_element.id).className = "checkedfield";


            } else {
                transcript.push(String.fromCharCode(64 + r) + "," + c + "," + "x");
                document.getElementById(target_element.id).style.backgroundColor = "red";
                document.getElementById(target_element.id).className = "checkedfield";
                controlSum2++;

                if (last_shot_on_target != []) {
                    if (last_shot_on_target[0] == r) {
                        line_of_shooting = [0, r];
                    }
                    if (last_shot_on_target[1] == c) {
                        line_of_shooting = [1, c];
                    }
                    for (let i = 0; i < potential_targets.length; i++) {
                        if (last_shot_on_target[0] == r) {
                            if (potential_targets[i][0] != r) {
                                potential_targets.splice(i, 1);
                                i--;
                            }
                        }
                        if (last_shot_on_target[1] == c) {
                            if (potential_targets[i][0] != c) {
                                potential_targets.splice(i, 1);
                                i--;
                            }
                        }
                    }
                }


                let control = 0;

                for (let i = 0; i < 10; i++) {
                    for (let j = 0; j < 10; j++) {
                        if (enemy_board[i][j] == enemy_board[r - 1][c - 1]) {
                            control++;
                        }
                    }
                }

                if (control == 1) {

                    for (const element of transcript) {
                        transcript_split = element.split(',');
                        if (transcript_split[2] == "x" && sunken_ships_locations.includes([transcript_split[0].charCodeAt(0) - 64, parseInt(transcript_split[1])]) == false) {
                            sunken_ships_locations.push([transcript_split[0].charCodeAt(0) - 64, parseInt(transcript_split[1])]);
                        }

                    }
                    for (const ship_location of sunken_ships_locations) {
                        let i = ship_location[0];
                        let j = ship_location[1];
                        if (j > 1) {
                            document.getElementById("player_1_own_board," + i + "," + (j - 1).toString()).className = "checkedfield";
                            if (i > 1) {
                                document.getElementById("player_1_own_board," + (i - 1).toString() + "," + (j - 1).toString()).className = "checkedfield";
                            }
                        }
                        if (j < 10) {
                            document.getElementById("player_1_own_board," + i + "," + (j + 1).toString()).className = "checkedfield";
                            if (i > 1) {
                                document.getElementById("player_1_own_board," + (i - 1).toString() + "," + (j + 1).toString()).className = "checkedfield";
                            }
                        }
                        if (i > 1) {
                            document.getElementById("player_1_own_board," + (i - 1).toString() + "," + j).className = "checkedfield";

                        }
                        if (i < 10) {
                            document.getElementById("player_1_own_board," + (i + 1).toString() + "," + j).className = "checkedfield";
                            if (j < 10) {
                                document.getElementById("player_1_own_board," + (i + 1).toString() + "," + (j + 1).toString()).className = "checkedfield";
                            }
                            if (j > 1) {
                                document.getElementById("player_1_own_board," + (i + 1).toString() + "," + (j - 1).toString()).className = "checkedfield";

                            }
                        }


                    }
                    potential_targets = [];
                    line_of_shooting = [];
                    alert("Przeciwnik trafia, i zatapia twój okręt!!!!");
                } else {
                    alert("Przeciwnik trafia!");

                }
                enemy_board[r - 1][c - 1] = 0;

                controlSum2 = hard_mode(transcript, enemy_board, controlSum2, sunken_ships_locations, enemy_starting_board, potential_targets, line_of_shooting);
            }
            console.log("linia strzału:");
            console.log(line_of_shooting);
            console.log("dalsze strzały to");
            console.log(potential_targets);
            return controlSum2;

        }

        $(document).ready(function () {

            let empty_board = [];
            let empty_board2 = [];
            let board = [];
            let board2 = [];
            let starting_board_of_p1 = [];
            let fleet = [];
            let player1_game_transcript = [];
            let player2_game_transcript = [];
            let potential_targets = [];
            let game_on = true;
            let sunken_ships_locations = [];
            let line_of_shooting = [];

            let controlSum = 0;
            let controlSum2 = 0;
            let player1count = 0;
            let player2count = 0;

            let currentPlayer = 1;
            for (let i = 0; i < 10; i++) {
                empty_board[i] = [];
                empty_board2[i] = [];
                board[i] = [];
                board2[i] = [];
                starting_board_of_p1[i] = [];
                for (let j = 0; j < 10; j++) {
                    empty_board[i][j] = 0;
                    empty_board2[i][j] = 0;
                    board[i][j] = 0;
                    board2[i][j] = 0;
                    starting_board_of_p1[i][j] = 0;
                }
            }

            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 4 - i; j++) {
                    fleet.push(i + 1);
                }
            }
            randomly_locate_ships(board, fleet.reverse(), empty_board);
            randomly_locate_ships(board2, fleet.reverse(), empty_board2);
            for (let i = 0; i < 10; i++) {
                for (let j = 0; j < 10; j++) {
                    starting_board_of_p1[i][j] = board[i][j];
                }
            }

            createBoard(board, document.getElementById("player_1_own_board"), document.getElementById("player_1_enemy_board"));
            createBoard(board2, document.getElementById("player_2_own_board"), document.getElementById("player_2_enemy_board"));

            $("#player_2_enemy_board").hide();
            $("#player_2_own_board").hide();


            for (let iter = 0; iter < 2; iter++) {
                if (iter == 0) {
                    var nodes = document.getElementById('player_1_own_board').childNodes;
                    var player = 'player_1_own_board,';
                } else if (iter == 1) {
                    var nodes = document.getElementById('player_2_own_board').childNodes;
                    var player = 'player_2_own_board,';
                }
                for (var i = 0; i < nodes.length; i++) {
                    let childs = nodes[i].childNodes;
                    for (var k = 0; k < childs.length; k++) {
                        let childs2 = childs[k].childNodes;
                        for (var j = 0; j < childs2.length; j++) {
                            childs2[j].id = player + childs2[j].id;

                        }
                    }
                }
            }

            $(".enemys-field").click(function () {
                let rowcol = this.id.split(',');
                let r = parseInt(rowcol[0]);
                let c = parseInt(rowcol[1]);

                if (game_on) {
                    if (this.className === "enemys-field") {
                        this.className = "checkedfield";
                        if (currentPlayer == 1) {
                            player1count++;
                            if (board2[r - 1][c - 1] == 0) {
                                document.getElementById("player_2_own_board," + this.id).style.backgroundColor = "blue";

                                this.style.backgroundColor = "blue";
                                player1_game_transcript.push(String.fromCharCode(64 + r) + "," + c + "," + "o");
                                {% if mode == "multiplayer" %}
                                    $("#player_1_enemy_board").hide();
                                    $("#player_1_own_board").hide();
                                    $("#player_2_enemy_board").show();
                                    $("#player_2_own_board").show();
                                {% endif %}
                                currentPlayer = 2;
                                alert("pudło(" + String.fromCharCode(64 + r) + c.toString() + ") ruch 2. gracza");
                                {%  if mode == "easy" %}
                                    controlSum2 = easy_mode(player2_game_transcript, board, controlSum2);
                                    if (controlSum2 == 20) {
                                        player2count = player2_game_transcript.length;
                                        alert("Zwycięża komputer!");
                                        let result1 = 100 * (controlSum / player1count);
                                        let result2 = 100 * (controlSum2 / player2count);
                                        document.getElementById('mode').value = "{{ mode }}";
                                        document.getElementById('player1').value = "{{ request.user }}";
                                        document.getElementById('player2').value = "AI";
                                        document.getElementById('result1').value = result1;
                                        document.getElementById('result2').value = result2;
                                        document.getElementById('transcript1').value = player1_game_transcript;
                                        document.getElementById('transcript2').value = player2_game_transcript;
                                        $('#resultform').trigger('submit');
                                        game_on = false;
                                    }
                                    currentPlayer = 1;
                                {% elif mode == "medium" %}
                                    controlSum2 = medium_mode(player2_game_transcript, board, controlSum2)
                                    if (controlSum2 == 20) {
                                        player2count = player2_game_transcript.length;
                                        alert("Zwycięża komputer!");
                                        let result1 = 100 * (controlSum / player1count);
                                        let result2 = 100 * (controlSum2 / player2count);
                                        document.getElementById('mode').value = "{{ mode }}";
                                        document.getElementById('player1').value = "{{ request.user }}";
                                        document.getElementById('player2').value = "AI";
                                        document.getElementById('result1').value = result1;
                                        document.getElementById('result2').value = result2;
                                        document.getElementById('transcript1').value = player1_game_transcript;
                                        document.getElementById('transcript2').value = player2_game_transcript;
                                        $('#resultform').trigger('submit');
                                        game_on = false;
                                    }
                                    currentPlayer = 1;
                                {% elif mode == "hard" %}
                                    controlSum2 = hard_mode(player2_game_transcript, board, controlSum2, sunken_ships_locations, starting_board_of_p1, potential_targets, line_of_shooting);
                                    if (controlSum2 == 20) {
                                        player2count = player2_game_transcript.length;
                                        alert("Zwycięża komputer!");
                                        let result1 = 100 * (controlSum / player1count);
                                        let result2 = 100 * (controlSum2 / player2count);
                                        document.getElementById('mode').value = "{{ mode }}";
                                        document.getElementById('player1').value = "{{ request.user }}";
                                        document.getElementById('player2').value = "AI";
                                        document.getElementById('result1').value = result1;
                                        document.getElementById('result2').value = result2;
                                        document.getElementById('transcript1').value = player1_game_transcript;
                                        document.getElementById('transcript2').value = player2_game_transcript;
                                        $('#resultform').trigger('submit');
                                        game_on = false;
                                    }
                                    currentPlayer = 1;
                                {% endif %}
                            } else if (board2[r - 1][c - 1] != 0) {
                                document.getElementById("player_2_own_board," + this.id).style.backgroundColor = "red";
                                document.getElementById("player_2_own_board," + this.id).textContent = "X";
                                this.style.backgroundColor = "red";
                                this.textContent = "X";
                                controlSum++;
                                player1_game_transcript.push(String.fromCharCode(64 + r) + "," + c + "," + "x");
                                {#console.log(board2[r - 1][c - 1])#}

                                let control = 0;
                                for (let i = 0; i < 10; i++) {
                                    for (let j = 0; j < 10; j++) {
                                        if (board2[i][j] == board2[r - 1][c - 1]) {
                                            control++;
                                        }
                                    }
                                }
                                board2[r - 1][c - 1] = 0;
                                if (control == 1) {
                                    alert("trafiony, zatopiony!");
                                } else {
                                    alert("trafiony!");
                                }
                            }
                            if (controlSum == 20) {
                                player2count = player2_game_transcript.length;
                                alert("koniec gry wygrał gracz 1.");
                                let result1 = 100 * (controlSum / player1count);
                                let result2 = 100 * (controlSum2 / player2count);
                                document.getElementById('mode').value = "{{ mode }}";
                                document.getElementById('player1').value = "{{ request.user }}";
                                document.getElementById('player2').value = "{{ player2_username }}";
                                document.getElementById('result1').value = result1;
                                document.getElementById('result2').value = result2;
                                document.getElementById('transcript1').value = player1_game_transcript;
                                document.getElementById('transcript2').value = player2_game_transcript;
                                $('#resultform').trigger('submit');
                                game_on = false;
                            }
                        } {% if mode == "multiplayer" %} else if (currentPlayer == 2) {
                            player2count++;

                            if (board[r - 1][c - 1] === 0) {

                                document.getElementById("player_1_own_board," + this.id).style.backgroundColor = "blue";
                                this.style.backgroundColor = "blue";
                                player2_game_transcript.push(String.fromCharCode(64 + r) + "," + c.toString() + "," + "o");

                                $("#player_2_enemy_board").hide();
                                $("#player_2_own_board").hide();
                                $("#player_1_enemy_board").show();
                                $("#player_1_own_board").show();
                                currentPlayer = 1;
                                alert("pudło(" + String.fromCharCode(64 + r) + c.toString() + ") ruch 1. gracza");

                            } else if (board[r - 1][c - 1] != 0) {
                                document.getElementById("player_1_own_board," + this.id).style.backgroundColor = "red";
                                document.getElementById("player_1_own_board," + this.id).textContent = "X";
                                this.style.backgroundColor = "red";
                                this.textContent = "X";
                                controlSum2++;
                                player2_game_transcript.push(String.fromCharCode(64 + r) + "," + c.toString() + "," + "x");

                                let control = 0;
                                for (let i = 0; i < 10; i++) {
                                    for (let j = 0; j < 10; j++) {
                                        if (board[i][j] == board[r - 1][c - 1]) {
                                            control++;
                                        }
                                    }
                                }
                                board[r - 1][c - 1] = 0;
                                if (control == 1) {
                                    alert("trafiony, zatopiony!" + parseInt(control));
                                } else {
                                    alert("trafiony!" + parseInt(control));
                                }

                            }
                            if (controlSum2 == 20) {
                                player2count = player2_game_transcript.length;
                                alert("koniec gry, wygrał gracz 2.");
                                let result1 = 100 * (controlSum / player1count);
                                let result2 = 100 * (controlSum2 / player2count);
                                document.getElementById('mode').value = "{{ mode }}";
                                document.getElementById('player1').value = "{{ request.user }}";
                                document.getElementById('player2').value = "{{ player2_username }}";
                                document.getElementById('result1').value = result1;
                                document.getElementById('result2').value = result2;
                                document.getElementById('transcript1').value = player1_game_transcript;
                                document.getElementById('transcript2').value = player2_game_transcript;
                                $('#resultform').trigger('submit');
                            }
                        }{% endif %}
                    } else {
                        alert("już tam strzelałeś!")
                    }
                } else {
                    alert("Gra dobiegła końca!")
                }
            });

        });
    </script>

    <script>
        $('#resultform').on('submit', function (e) {
            e.preventDefault();
            alert('cosiedzieje')
            alert($('#mode').val())
            $.ajax({
                type: "POST",
                url: "{% url 'saveresult' mode %}",
                data: {
                    mode: $('#mode').val(),
                    player1: $('#player1').val(),
                    player2: $('#player2').val(),
                    result1: $('#result1').val(),
                    result2: $('#result2').val(),
                    transcript1: $('#transcript1').val(),
                    transcript2: $('#transcript2').val(),
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    dataType: "json",
                },

                success: function (data) {
                    console.log(data)
                    location.href =
                    {% url 'statistics' %}
                },

                failure: function () {
                    console.log('cojest!!')
                }
            });
        });
    </script>
{% endblock content %}